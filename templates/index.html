<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AMS Filament Manager â€” Material Dark</title>

  <!-- Roboto + Material Icons -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Material Components Web (official) -->
  <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css">

  <style>
    /* Material theme variables (dark) */
    :root{
      --mdc-theme-primary: #00ff62;
      --mdc-theme-secondary: #79db9f;
      --mdc-theme-error: #ff0000;
      --mdc-theme-background: #0f1113;
      --mdc-theme-surface: #15161a;
      --mdc-theme-on-surface: #e6e8ef;
      --mdc-theme-on-primary: #001219;
      --mdc-theme-surface-variant: #1b1e24;
      --app-radius: 12px;
    }

    /* Page basics */
    html,body{height:100%;margin:0;font-family:Roboto, "Segoe UI", sans-serif;background:var(--mdc-theme-background);color:var(--mdc-theme-on-surface);}
    .page {max-width:1200px;margin: 84px auto 40px; padding:20px;}
    /* Top app bar spacing */
    .mdc-top-app-bar { position: fixed; top: 0; left: 0; right: 0; z-index: 30; background: var(--mdc-theme-surface); color:var(--mdc-theme-on-surface); box-shadow: 0 6px 18px rgba(0,0,0,0.6);}

    /* Header */
    .hero {
      background: var(--mdc-theme-surface);
      border-radius: var(--app-radius);
      padding: 22px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.55);
      display:flex;
      align-items:center;
      gap:18px;
      margin-bottom:24px;
    }
    .hero .title { font-size:1.5rem; color:var(--mdc-theme-primary); font-weight:500; display:flex; align-items:center; gap:12px; }
    .hero .subtitle { color: #9ea4b7; font-size:0.95rem; }
    .hero .version { font-size:0.9rem; color:#9ea4b7; margin-top:6px; }

    /* Grid layout */
    .grid {
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:20px;
      margin-bottom:20px;
    }
    @media (max-width: 820px){ .grid { grid-template-columns: 1fr; } }

    /* MDC card overrides for dark look */
    .mdc-card { background: var(--mdc-theme-surface); border-radius: 12px; box-shadow: none; border: 1px solid rgba(255,255,255,0.03); }
    .card-inner { padding:18px; }

    .status-row { display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.03); align-items:center; }
    .status-row:last-child { border-bottom: none; }
    .status-label { color:#9ea4b7; font-weight:500; }
    .status-value { font-weight:600; color:var(--mdc-theme-on-surface); }

    .connected { color: #06d6a0; }
    .disconnected { color: #f72585; }

    /* Filaments area */
    .filaments-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:18px; }

    .filament-card { border-radius: 12px; overflow: hidden; border:1px solid rgba(255,255,255,0.03); transition: box-shadow .18s ease, transform .12s ease; }
    .filament-card.mdc-card:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(0,0,0,0.6); }
    .filament-card.loaded { box-shadow: 0 8px 28px rgba(6,214,160,0.12); border-color: rgba(6,214,160,0.16); }

    .filament-header { display:flex; align-items:center; gap:12px; padding-bottom:10px; }
    .filament-number {
      width:44px;height:44px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;background:var(--mdc-theme-secondary); color:white;font-weight:700;
    }
    .filament-name { font-weight:600; font-size:1.05rem; color:var(--mdc-theme-on-surface); }

    /* Outline swatch for filament color */
    .filament-color {
      width:100%; height:64px; border-radius:8px;
      background:transparent; border:3px solid rgba(255,255,255,0.04);
      margin:10px 0 16px; transition: border-color .18s linear, box-shadow .18s ease;
    }

    /* controls */
    .controls { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:6px; }
    .input-group { margin-bottom:10px; }

    /* make color input slightly Material-like */
    input[type="color"] {
      -webkit-appearance:none; border:none; background:transparent; padding:0; width:42px; height:42px; border-radius:8px; cursor:pointer;
      box-shadow: inset 0 0 0 3px rgba(255,255,255,0.03);
    }
    /* small text fields */
    .mdc-text-field--filled .mdc-text-field__input { color:var(--mdc-theme-on-surface); background:transparent; }

    /* quick actions layout */
    .quick-actions { display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:12px; }

    /* notification */
    .notification {
      position: fixed;
      top:84px; right:20px;
      z-index:60;
      background:#111217;
      color:white;
      padding:12px 18px 18px; /* extra bottom padding for bar */
      border-radius:10px;
      font-weight: 800;  
      box-shadow:0 8px 28px rgba(0,0,0,0.6);
      transform:translateX(240px);
      transition:transform .28s cubic-bezier(.2,.9,.2,1);
      overflow:hidden;
    }
    .notification.show { transform:translateX(0); }

    /* progress bar at bottom */
    .notification .bar {
      position:absolute;
      left:0;
      bottom:0;
      height:4px;
      width:100%;
      background:var(--mdc-theme-primary);
      transform-origin:left;
      transform:scaleX(1);
      transition:transform 3s linear;
    }
    .notification.hide .bar {
      transform:scaleX(0);
    }

    .notification.success { background: linear-gradient(180deg,#000000,#000000); color:#ffffff; }
    .notification.error { background: linear-gradient(180deg,#000000,#000000); color:#fff; }

    /* small tweaks for MDC buttons */
    .mdc-button { border-radius: 10px; text-transform:none; }
    .mdc-button--raised.mdc-button--primary { background:var(--mdc-theme-primary); color:var(--mdc-theme-on-primary); }
    .mdc-button--raised.mdc-button--success { background:#06d6a0; color:#001219; }
    .mdc-button--raised.mdc-button--danger { background:var(--mdc-theme-error); color:white; }

    /* footer spacing when page is short */
    footer { margin-top:30px; color:#9ea4b7; font-size:0.9rem; text-align:center; }

    /* Settings Panel */
    .settings-panel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 380px;
      height: 100%;
      background: var(--mdc-theme-surface);
      box-shadow: -8px 0 30px rgba(0,0,0,0.6);
      z-index: 40;
      transition: right 0.3s ease;
      overflow-y: auto;
      padding: 20px;
    }
    
    .settings-panel.open {
      right: 0;
    }
    
    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .settings-title {
      font-size: 1.4rem;
      color: var(--mdc-theme-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .settings-close {
      background: none;
      border: none;
      color: var(--mdc-theme-on-surface);
      cursor: pointer;
      font-size: 24px;
    }
    
    .settings-section {
      margin-bottom: 24px;
      padding: 16px;
      background: var(--mdc-theme-surface-variant);
      border-radius: var(--app-radius);
    }
    
    .settings-section-title {
      font-size: 1.1rem;
      margin-bottom: 16px;
      color: var(--mdc-theme-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .settings-item {
      margin-bottom: 16px;
    }
    
    .settings-label {
      display: block;
      margin-bottom: 8px;
      color: #9ea4b7;
      font-size: 0.9rem;
    }
    
    .settings-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: var(--mdc-theme-background);
      color: var(--mdc-theme-on-surface);
      font-size: 1rem;
    }
    
    .settings-hint {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 4px;
    }
    
    .settings-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 35;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* small responsive adjustments */
    @media (max-width:420px) {
      .hero { flex-direction:column; align-items:flex-start; gap:8px; }
      .filament-header { gap:8px; }
      .settings-panel {
        width: 100%;
        right: -100%;
      }
    }
  </style>
</head>
<body>

  <!-- Top App Bar (Material) -->
  <header class="mdc-top-app-bar mdc-top-app-bar--fixed" role="banner">
    <div class="mdc-top-app-bar__row">
      <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
        <span class="mdc-top-app-bar__title">OSMAMS Web UI</span>
      </section>
      <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-end" role="toolbar">
        <button class="material-icons mdc-icon-button" title="Refresh" id="appRefreshBtn">refresh</button>
        <button class="material-icons mdc-icon-button" title="Settings" id="appSettingsBtn">settings</button>
      </section>
    </div>
  </header>

  <main class="page" role="main">
    <div class="hero">
      <div style="display:flex;align-items:center;gap:12px;">
        <span class="material-icons" style="font-size:36px;color:var(--mdc-theme-primary)">print</span>
      </div>
      <div>
        <div class="title">OSMAMS</div>
        <div class="subtitle">Open Source Marlin Automatic Material System</div>
        <div class="version" style="color:#9ea4b7; font-size:0.9rem; margin-top:6px;">v1.0.0</div>
    </div>
    </div>

    <!-- Status cards grid -->
    <div class="grid">
      <div class="mdc-card">
        <div class="card-inner">
          <h3 style="color:var(--mdc-theme-primary); margin:0 0 12px 0; display:flex;align-items:center;gap:10px;">
            <span class="material-icons">print</span> Printer Status
          </h3>
          <div class="status-row"><div class="status-label">Connection</div><div id="printerStatus" class="status-value">Checking...</div></div>
          <div class="status-row"><div class="status-label">State</div><div id="printerState" class="status-value">-</div></div>
          <div class="status-row"><div class="status-label">Nozzle Temp</div><div id="nozzleTemp" class="status-value">-</div></div>
          <div class="status-row"><div class="status-label">Bed Temp</div><div id="bedTemp" class="status-value">-</div></div>
        </div>
      </div>

      <div class="mdc-card">
        <div class="card-inner">
          <h3 style="color:var(--mdc-theme-primary); margin:0 0 12px 0; display:flex;align-items:center;gap:10px;">
            <span class="material-icons">layers</span> AMS Status
          </h3>
          <div class="status-row"><div class="status-label">Connection</div><div id="amsStatus" class="status-value">Checking...</div></div>
          <div class="status-row"><div class="status-label">Loaded Filament</div><div id="loadedFilament" class="status-value">-</div></div>
          <div class="status-row"><div class="status-label">Print Progress</div><div id="printProgress" class="status-value">-</div></div>
          <div class="status-row"><div class="status-label">Remaining Time</div><div id="remainingTime" class="status-value">-</div></div>
        </div>
      </div>
    </div>

    <!-- Filaments -->
    <section class="filaments-grid" id="filamentsGrid">
      <!-- inserted by JS -->
    </section>

    <!-- Quick actions -->
    <div class="quick-actions" style="margin-top: 24px;">
      <button id="refreshBtn" class="mdc-button mdc-button--raised">
        <span class="mdc-button__ripple"></span>
        <span class="material-icons">refresh</span>&nbsp;Refresh All
      </button>
      <button id="unloadBtn" class="mdc-button mdc-button--raised mdc-button--danger">
        <span class="mdc-button__ripple"></span>
        <span class="material-icons">eject</span>&nbsp;Unload Filament
      </button>
    </div>
  </main>

  <!-- Settings Panel -->
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-header">
      <h2 class="settings-title">
        <span class="material-icons">settings</span>
        Settings
      </h2>
      <button class="settings-close" id="settingsCloseBtn">
        <span class="material-icons">close</span>
      </button>
    </div>
    
    <div class="settings-section">
      <h3 class="settings-section-title">
        <span class="material-icons">update</span>
        Refresh Rates
      </h3>
      
      <div class="settings-item">
        <label class="settings-label" for="statusRefreshRate">Status Refresh Rate (ms)</label>
        <input type="number" id="statusRefreshRate" class="settings-input" min="1000" step="1000">
        <div class="settings-hint">How often to update printer and AMS status (default: 3000ms)</div>
      </div>
      
      <div class="settings-item">
        <label class="settings-label" for="filamentRefreshRate">Filament Data Refresh Rate (ms)</label>
        <input type="number" id="filamentRefreshRate" class="settings-input" min="2000" step="1000">
        <div class="settings-hint">How often to update filament information (default: 5000ms)</div>
      </div>
    </div>
    
    <div class="settings-section">
      <h3 class="settings-section-title">
        <span class="material-icons">palette</span>
        Interface
      </h3>
      
      <div class="settings-item">
        <label class="settings-label" for="themeSelect">Theme</label>
        <select id="themeSelect" class="settings-input">
          <option value="dark">Dark (Default)</option>
          <option value="light">Light</option>
          <option value="auto">Auto (Follow System)</option>
        </select>
      </div>
    </div>
    
    <div class="settings-actions">
      <button id="settingsSaveBtn" class="mdc-button mdc-button--raised mdc-button--primary">
        <span class="mdc-button__ripple"></span>
        Save Settings
      </button>
      <button id="settingsResetBtn" class="mdc-button">
        <span class="mdc-button__ripple"></span>
        Reset to Defaults
      </button>
    </div>
  </div>
  
  <!-- Overlay -->
  <div class="overlay" id="settingsOverlay"></div>

  <!-- Notification -->
  <div id="notification" class="notification" aria-live="polite">
    <span id="notificationText"></span>
    <div class="bar"></div>
  </div>
  
  <!-- MDC JS -->
  <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
  <script>
    // Initialize top app bar and ripples / buttons
    const topAppBar = mdc.topAppBar.MDCTopAppBar.attachTo(document.querySelector('.mdc-top-app-bar'));
    // attach ripples to all mdc buttons for consistent Material interaction
    Array.from(document.querySelectorAll('.mdc-button, .mdc-icon-button')).forEach(el => mdc.ripple.MDCRipple.attachTo(el));

    // App logic
    let currentFilaments = {};
    let statusInterval, filamentInterval;
    let appSettings = {
      statusRefreshRate: 3000,
      filamentRefreshRate: 5000,
      theme: 'dark'
    };

    // Load settings from localStorage
    function loadSettings() {
      const saved = localStorage.getItem('osmamsSettings');
      if (saved) {
        try {
          appSettings = { ...appSettings, ...JSON.parse(saved) };
        } catch (e) {
          console.error('Failed to parse saved settings', e);
        }
      }
      
      // Update UI with loaded settings
      document.getElementById('statusRefreshRate').value = appSettings.statusRefreshRate;
      document.getElementById('filamentRefreshRate').value = appSettings.filamentRefreshRate;
      document.getElementById('themeSelect').value = appSettings.theme;
      
      // Apply theme
      applyTheme(appSettings.theme);
      
      // Restart intervals with new rates
      restartIntervals();
    }

    // Save settings to localStorage
    function saveSettings() {
      localStorage.setItem('osmamsSettings', JSON.stringify(appSettings));
      restartIntervals();
      applyTheme(appSettings.theme);
      showNotification('Settings saved', 'success');
    }

    // Apply theme
    function applyTheme(theme) {
      // Remove existing theme classes
      document.body.classList.remove('theme-dark', 'theme-light');
      
      // Determine which theme to apply
      let themeToApply = theme;
      if (theme === 'auto') {
        themeToApply = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      
      // Apply the theme
      document.body.classList.add(`theme-${themeToApply}`);
    }

    // Restart intervals with current settings
    function restartIntervals() {
      // Clear existing intervals
      if (statusInterval) clearInterval(statusInterval);
      if (filamentInterval) clearInterval(filamentInterval);
      
      // Set up new intervals
      statusInterval = setInterval(updateStatus, appSettings.statusRefreshRate);
      filamentInterval = setInterval(loadFilamentData, appSettings.filamentRefreshRate);
    }

    async function loadFilamentData() {
      try {
        const resp = await fetch('/api/filaments');
        // if endpoint fails or returns non-JSON, fallback gracefully
        currentFilaments = resp.ok ? await resp.json() : {};
      } catch (err) {
        console.error('Error loading filament data', err);
        currentFilaments = {};
      }
      renderFilaments();
      updateStatus();
    }

    // Render the filament cards using Material card visuals
    function renderFilaments() {
      const grid = document.getElementById('filamentsGrid');
      grid.innerHTML = '';
      const entries = Object.entries(currentFilaments || {});
      if (entries.length === 0) {
        // placeholder card
        const placeholder = document.createElement('div');
        placeholder.className = 'mdc-card';
        placeholder.innerHTML = '<div class="card-inner" style="text-align:center;color:#9ea4b7">No filaments configured (response from /api/filaments was empty)</div>';
        grid.appendChild(placeholder);
        return;
      }

      entries.forEach(([num, info]) => {
        const isLoaded = !!info.loaded;
        const card = document.createElement('div');
        card.className = 'mdc-card filament-card' + (isLoaded ? ' loaded' : '');
        const nameEsc = (info.name || 'Unnamed').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const color = info.color || '#888888';

        card.innerHTML = `
          <div class="card-inner">
            <div class="filament-header">
              <div class="filament-number">${num}</div>
              <div class="filament-name">${nameEsc}</div>
            </div>

            <div class="filament-color" style="border-color: ${color}; box-shadow: ${isLoaded ? '0 6px 18px rgba(76,201,240,0.08)' : 'none'}"></div>

            <div class="input-group" style="display:flex;align-items:center;gap:12px;">
              <label style="color:#9ea4b7;font-size:0.9rem;">Color</label>
              <input aria-label="filament-color-${num}" type="color" value="${color}" onchange="updateColor(${num}, this.value)">
              <div style="flex:1"></div>
            </div>

            <div class="input-group">
              <label style="color:#9ea4b7;font-size:0.9rem;">Filament Name</label>
              <input class="mdc-text-field__input" type="text" value="${nameEsc}" onchange="updateName(${num}, this.value)" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:#0f1113; color:var(--mdc-theme-on-surface);">
            </div>

            <div class="controls">
              <button class="mdc-button mdc-button--raised mdc-button--primary" onclick="loadFilament(${num}, this)" ${isLoaded ? 'disabled' : ''}>
                <span class="mdc-button__ripple"></span>
                <span class="material-icons">arrow_downward</span>&nbsp;Load
              </button>
              <button class="mdc-button mdc-button--raised mdc-button--success" onclick="testFilament(${num})">
                <span class="mdc-button__ripple"></span>
                <span class="material-icons">science</span>&nbsp;Test
              </button>
            </div>
          </div>
        `;
        grid.appendChild(card);
        // attach ripples for dynamic buttons
        Array.from(card.querySelectorAll('.mdc-button')).forEach(el => mdc.ripple.MDCRipple.attachTo(el));
      });
    }

    // Status updates
    async function updateStatus() {
      try {
        const printerResp = await fetch('/api/printer/status');
        if (printerResp.ok) {
          const printerData = await printerResp.json();
          const pStatusEl = document.getElementById('printerStatus');
          const state = printerData.status || 'UNKNOWN';
          pStatusEl.textContent = (state === 'DISCONNECTED') ? 'Disconnected' : 'Connected';
          pStatusEl.className = 'status-value ' + (state === 'DISCONNECTED' ? 'disconnected' : 'connected');
          document.getElementById('printerState').textContent = state;
        }
      } catch (err) {
        console.error('Printer status error', err);
        const pStatusEl = document.getElementById('printerStatus');
        pStatusEl.textContent = 'Error';
        pStatusEl.className = 'status-value disconnected';
      }

      try {
        const amsResp = await fetch('/api/loaded');
        if (amsResp.ok) {
          const amsData = await amsResp.json();
          const loaded = amsData.loaded;
          const amsEl = document.getElementById('amsStatus');
          amsEl.textContent = loaded ? 'Connected' : 'Disconnected';
          amsEl.className = 'status-value ' + (loaded ? 'connected' : 'disconnected');
          document.getElementById('loadedFilament').textContent = loaded ? `Filament ${loaded} - ${currentFilaments[loaded]?.name || 'Unknown'}` : 'None';

          // mark loaded in local list and re-render
          if (currentFilaments) {
            Object.values(currentFilaments).forEach(f => f.loaded = false);
            if (loaded && currentFilaments[loaded]) currentFilaments[loaded].loaded = true;
            renderFilaments();
          }
        }
      } catch (err) {
        console.error('AMS status error', err);
      }
    }

    // Handlers (pass element for reliable button state)
    async function loadFilament(filamentNum, btnEl) {
      if (!btnEl) return;
      const orig = btnEl.innerHTML;
      btnEl.disabled = true;
      btnEl.innerHTML = '<span class="mdc-button__ripple"></span><span class="material-icons">autorenew</span>&nbsp;Loading...';
      try {
        const res = await fetch(`/api/load/${filamentNum}`, { method: 'POST' });
        const json = res.ok ? await res.json() : { success:false, error: 'Network error' };
        if (json.success) {
          showNotification(json.message || `Loaded ${filamentNum}`, 'success');
          await loadFilamentData();
        } else {
          showNotification('Error: ' + (json.error || 'unknown'), 'error');
        }
      } catch (err) {
        console.error('loadFilament error', err);
        showNotification('Error loading filament: ' + err, 'error');
      } finally {
        btnEl.disabled = false;
        btnEl.innerHTML = orig;
      }
    }

    async function unloadFilament() {
      const btn = document.getElementById('unloadBtn');
      const orig = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="mdc-button__ripple"></span><span class="material-icons">autorenew</span>&nbsp;Unloading...';
      try {
        const r = await fetch('/api/unload', { method: 'POST' });
        const j = r.ok ? await r.json() : { success:false, error:'network' };
        if (j.success) {
          showNotification(j.message || 'Unloaded', 'success');
          await loadFilamentData();
        } else showNotification('Error: ' + (j.error || 'unknown'), 'error');
      } catch (err) {
        console.error('unload error', err);
        showNotification('Error unloading filament: ' + err, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = orig;
      }
    }

    function testFilament(filamentNum) {
      showNotification(`Testing filament ${filamentNum}...`, 'success');
      // expand with actual test logic if available
    }

    async function updateColor(filamentNum, color) {
      try {
        const r = await fetch(`/api/color/${filamentNum}`, {
          method:'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ color })
        });
        const j = r.ok ? await r.json() : { success:false, error:'network' };
        if (j.success) {
          if (currentFilaments[filamentNum]) currentFilaments[filamentNum].color = color;
          renderFilaments();
        } else showNotification('Error updating color: ' + (j.error || 'unknown'), 'error');
      } catch (err) {
        console.error('updateColor error', err);
        showNotification('Error updating color: ' + err, 'error');
      }
    }

    async function updateName(filamentNum, name) {
      try {
        const r = await fetch(`/api/color/${filamentNum}`, {
          method:'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ name })
        });
        const j = r.ok ? await r.json() : { success:false, error:'network' };
        if (!j.success) showNotification('Error updating name: ' + (j.error || 'unknown'), 'error');
      } catch (err) {
        console.error('updateName error', err);
        showNotification('Error updating name: ' + err, 'error');
      }
    }

    // notifications
    const notificationEl = document.getElementById('notification');
    const notificationTextEl = document.getElementById('notificationText');

    function showNotification(message, type='success') {
      notificationTextEl.textContent = message;
      notificationEl.className = 'notification show ' + type;
      // reset bar to full width instantly
      const bar = notificationEl.querySelector('.bar');
      bar.style.transition = 'none';
      bar.style.transform = 'scaleX(1)';
      // force reflow so next transition runs
      void bar.offsetWidth;
      // start depletion
      bar.style.transition = 'transform 3s linear';
      bar.style.transform = 'scaleX(0)';
      // hide after 3s
      setTimeout(()=>{
        notificationEl.classList.remove('show');
      },3000);
    }

    // Settings panel functions
    function openSettings() {
      document.getElementById('settingsPanel').classList.add('open');
      document.getElementById('settingsOverlay').classList.add('active');
    }

    function closeSettings() {
      document.getElementById('settingsPanel').classList.remove('open');
      document.getElementById('settingsOverlay').classList.remove('active');
    }

    function saveSettingsFromUI() {
      // Get values from UI
      appSettings.statusRefreshRate = parseInt(document.getElementById('statusRefreshRate').value) || 3000;
      appSettings.filamentRefreshRate = parseInt(document.getElementById('filamentRefreshRate').value) || 5000;
      appSettings.theme = document.getElementById('themeSelect').value;
      
      // Validate values
      if (appSettings.statusRefreshRate < 1000) appSettings.statusRefreshRate = 1000;
      if (appSettings.filamentRefreshRate < 2000) appSettings.filamentRefreshRate = 2000;
      
      // Save and apply
      saveSettings();
      closeSettings();
    }

    function resetSettings() {
      // Reset to defaults
      appSettings = {
        statusRefreshRate: 3000,
        filamentRefreshRate: 5000,
        theme: 'dark'
      };
      
      // Update UI
      document.getElementById('statusRefreshRate').value = appSettings.statusRefreshRate;
      document.getElementById('filamentRefreshRate').value = appSettings.filamentRefreshRate;
      document.getElementById('themeSelect').value = appSettings.theme;
      
      // Save and apply
      saveSettings();
    }

    // Event listeners
    document.getElementById('refreshBtn').addEventListener('click', async () => {
      const btn = document.getElementById('refreshBtn');
      const orig = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="mdc-button__ripple"></span><span class="material-icons">autorenew</span>&nbsp;Refreshing...';
      await updateStatus();
      await loadFilamentData();
      btn.disabled = false;
      btn.innerHTML = orig;
      showNotification('Status updated', 'success');
    });

    document.getElementById('unloadBtn').addEventListener('click', unloadFilament);
    document.getElementById('appRefreshBtn').addEventListener('click', async () => { 
      await updateStatus(); 
      showNotification('Refreshed', 'success'); 
    });
    document.getElementById('appSettingsBtn').addEventListener('click', openSettings);
    
    // Settings panel events
    document.getElementById('settingsCloseBtn').addEventListener('click', closeSettings);
    document.getElementById('settingsOverlay').addEventListener('click', closeSettings);
    document.getElementById('settingsSaveBtn').addEventListener('click', saveSettingsFromUI);
    document.getElementById('settingsResetBtn').addEventListener('click', resetSettings);

    // Listen for system theme changes if auto theme is selected
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      if (appSettings.theme === 'auto') {
        applyTheme('auto');
      }
    });

    // startup
    loadSettings();
    loadFilamentData();
  </script>
</body>
</html>